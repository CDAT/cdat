version: 2

jobs:
  build:
    machine:
      xcode:
        version: 7.2
      python:
        version: 3.6.0
    working_directory: /tmp
    steps:
      - run: echo "Install nightly..."
      - run: mkdir -p workspace
      - run:
          name: CloneUvcdatCode
          command: git clone -b validateNightly git@github.com:UV-CDAT/uvcdat workspace/uvcdat
      - run:
          name: InstallNightlyCdat
          command: python workspace/uvcdat/scripts/install_nightly.py -w workspace/test_nightly
      - run: echo "Done installing nightly"
      - run: ls workspace/test_nightly/miniconda/envs
      - persist_to_workspace:
          root: workspace
          paths: uvcdat test_nightly
  test:
    machine:
      xcode:
        version: 7.2
    working_directory: ~/workspace
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run: ls /tmp/workspace/test_nightly/miniconda/envs
      - run: 
          name: RunCdmsTest
          command: python /tmp/workspace/uvcdat/scripts/run_testsuite.py -w /tmp/workspace/test_nightly -p 'py2' -t 'cdms'
      - run: 
          name: RunGenutilTest
          command: python /tmp/workspace/uvcdat/scripts/run_testsuite.py -w /tmp/workspace/test_nightly -p 'py2' -t 'genutil'
      - run: 
          name: RunCdutilTest
          command: python /tmp/workspace/uvcdat/scripts/run_testsuite.py -w /tmp/workspace/test_nightly -p 'py2' -t 'cdutil'
      - run: 
          name: RunVcsTest
          command: python /tmp/workspace/uvcdat/scripts/run_testsuite.py -w /tmp/workspace/test_nightly -p 'py2' -t 'vcs'
      - run: 
          name: RunVcsaddonsTest
          command: python /tmp/workspace/uvcdat/scripts/run_testsuite.py -w /tmp/workspace/test_nightly -p 'py2' -t 'vcsaddons'

workflows:
  version: 2
  build_and_test:
    triggers: 
      - schedule:
          cron: "50 16 * * *"
    jobs:
      - build
      - test:
          requires:
            - build

