#!/bin/bash

# Main install prefix set by user or post install script:
# UVCDAT_INSTALL_PREFIX

# If unset, use the value configured by cmake by default.
# Everything beyond this point will be determined relatively
# from this path.
install_prefix="${UVCDAT_INSTALL_PREFIX:-@CMAKE_INSTALL_PREFIX@}"

function cleanup {
  unset cleanup install_prefix library_paths python_paths executable_paths
}

# Try to prevent the user from sourcing twice,
# which can lead to errors.
if [ -n "${UVCDAT_SETUP_PATH}" ] ; then
  if [ "${UVCDAT_SETUP_PATH}" = "${install_prefix}" ] ; then
    echo "UVCDAT setup already sourced for this install location." 1>&2
    cleanup
    return 1
  else
    echo "ERROR: UVCDAT setup was previously sourced at \"${UVCDAT_SETUP_PATH}\"" 1>&2
    echo "Open a new shell in order to use a different install location." 1>&2
    cleanup
    return 1
  fi
fi

# Check that the install prefix exists, otherwise stop.
if [ ! -d "${install_prefix}" ] ; then
  echo "ERROR: \"${install_prefix}\" is not a directory." 1>&2
  cleanup
  return 1
fi

# cmake set variables
library_paths=( @SETUP_LIBRARY_PATHS@ )
python_paths=( @SETUP_PYTHON_PATHS@ )
executable_paths=( @SETUP_EXECUTABLE_PATHS@ )

if [ -d '@QT_LIB_DIR@' ] ; then
  LD_LIBRARY_PATH='@QT_LIB_DIR@:'"${LD_LIBRARY_PATH}"
fi

for d in "${library_paths[@]}" ; do
  f="${install_prefix}/${d}"
  if [ -d "${f}" ] ; then
    LD_LIBRARY_PATH="${f}:${LD_LIBRARY_PATH}"
  fi
done

if [ `uname` = 'Darwin' ] ; then
  export DYLD_FALLBACK_LIBRARY_PATH="${LD_LIBRARY_PATH}"
fi

for d in "${python_paths[@]}" ; do
  f="${install_prefix}/${d}"
  if [ -d "${f}" ] ; then
    PYTHONPATH="${f}:${PYTHONPATH}"
  fi
done

for d in "${executable_paths[@]}" ; do
  f="${install_prefix}/${d}"
  if [ -d "${f}" ] ; then
    PATH="${f}:${PATH}"
  fi
done

if [ -d "${install_prefix}/External/lib/R" ] ; then
  export R_HOME="${install_prefix}/External/lib/R"
fi

export OPAL_PREFIX="${install_prefix}/External"
export LIBOVERLAY_SCROLLBAR=0

export PATH
export LD_LIBRARY_PATH
export PYTHONPATH

export UVCDAT_SETUP_PATH="${install_prefix}"
cleanup
return 0
